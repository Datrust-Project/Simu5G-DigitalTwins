In this example the network consists of one UE connected to one gNB, one UPF, 
one NAT router and one router.

The client and server applications reside on different physical machines, 
connected as shown in the figure:

------------                                     ----------------------------                                    ------------
|  client  | [192.168.55.2] <----> [192.168.55.1]|<-----              ----->|[192.168.56.1] <----> [192.168.56.2]|  server  |
------------                                     |     |              |     |                                    ------------
                                                 |   [veth2]       [veth0]  | 
                                                 |192.168.3.2    192.168.2.2| 
                                                 |      |             |     |
                                                 |      --->Simu5G<----     |
                                                 ----------------------------
                                            
To run this example, you have to run the external applications: 

- For the client application use, e.g., "Iperf" with following command line:
  	iperf -c 10.0.2.1 -P 1 -i 1 -m -p 10021 -M 536.0B -l 10.0M -f m -t 0
- For the server application use, e.g., "Iperf" with the following command line:
  	iperf -s -P 1 -i 1 -p 10021

IP addresses and routing tables are set up by using mrt files (see "routing" folder).
 
 Packets sent needs to be smaller than the MTU of the veth interface (1500 byte by default)
 
*** NOTE ***
In order to run an emulation where both the endpoints of a connection are real applications,
the client application (e.g. on the UE) needs to use the IP address of the NAT router within the
simulation as destination address. Such NAT router element will perform Network Address 
Translation (NAT), according to the rules specified with the corresponding parameter in the 
INI file. 
In this example, the server IP address is 192.168.56.2, while the client IP address is 192.168.55.2.
The NAT rules on the simulated NAT router are set as:
   
    *.router.ipv4.natTable.config = xml("<config> \
                                            <entry type='prerouting' \
                                            packetDataFilter='*Ipv4Header and destAddress=~10.0.2.1' \
                                            srcAddress='10.0.3.2' destAddress='192.168.56.2'/> \
                                            <entry type='prerouting' \
                                            packetDataFilter='*Ipv4Header and destAddress=~10.0.3.2' \
                                            srcAddress='10.0.2.1' destAddress='192.168.55.2'/> \
                                         </config>")
*** NOTE ***
The ExtLowerEthernetInterface sends packets out using a "packet socket", hence it sends Ethernet frames
that need to know the MAC address of the receiving interface (veth0/veth2 in this case). When the IP 
address is outside the local network (i.e. another host), the routing table must know the gateway address, 
i.e. the IP address of the interface "physically" connected to the router (veth0/veth2 in this case). 
This means that the gateway must explicit in the routing table  
 
=== HOW TO BUILD AND RUN ===

1) Make sure that the emulation feature is enabled in the INET project:

- via the IDE: right-click on the 'inet' folder in the Project Explorer -> Properties;
               select OMNeT++ -> Project Features; 
               tick the box "Network emulation support".
- via the command line: in the root INET folder, type 'opp_featuretool enable NetworkEmulationSupport'.

  If the feature was disabled, recompile INET with the command 'make' (in the root INET folder).  


2) In order to be able to send/receive packets through sockets, set the application permissions: 

    sudo setcap cap_net_raw,cap_net_admin=eip path/to/opp_run
    sudo setcap cap_net_raw,cap_net_admin=eip path/to/opp_run_dbg
    sudo setcap cap_net_raw,cap_net_admin=eip path/to/opp_run_release


3) Compile Simu5G from the command line by running (in the root Simu5G folder):
    $ . setenv
	$ make makefiles
	$ make 
	 	
	 	
4) Run the simulation by launching either ./run_wSocket.sh or ./run_wTun.sh 

============================
